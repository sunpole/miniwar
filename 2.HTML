<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–∞–ª–µ–Ω—å–∫–∞—è –í–æ–π–Ω–∞ 7.0</title>
  

<style>

html, body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #0a0a0a;
  color: #fff;
  overflow: hidden;
}

#game {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.header, .footer {
  flex-shrink: 0;
  padding: 10px;
  text-align: center;
  background: linear-gradient(to right, #1e1e1e, #2c2c2c);
  font-size: 14px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}

.header span, .footer span {
  margin: 0 10px;
}

.game-area {
  flex: 1;
  position: relative;
  background: #222;
}

canvas {
  display: block;
  margin: auto;
  background: #000;
  touch-action: none;
  pointer-events: none;
}

.button-panel {
  display: flex;
  padding: 5px;
  background: #111;
  height: 25vh;
}

.column {
  display: flex;
  flex-direction: column;
  flex: 1;
  gap: 6px;
  justify-content: flex-start;
  overflow-y: auto;
  padding-right: 5px;
  box-sizing: border-box;
}

/* –ö–Ω–æ–ø–∫–∏ */
button {
  cursor: pointer;
  flex: none;
  min-height: 48px; /* —É–º–µ–Ω—å—à–µ–Ω–∞ –≤—ã—Å–æ—Ç–∞ */
  background: linear-gradient(to bottom, #333, #222);
  color: #fff;
  border: 2px solid #555;
  border-radius: 10px;
  padding: 8px 12px 12px 12px; /* –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –ø–æ–ª–æ—Å–∫–∏ */
  font-size: 13px;
  font-weight: bold;
  box-shadow: 0 0 10px rgba(0,255,0,0);
  transition: all 0.3s ease;
  text-align: left;
  white-space: normal; /* —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏–ª—Å—è */
  position: relative;
  overflow: hidden; /* –¥–ª—è –ø–æ–ª–æ—Å–∫–∏ –∫—É–ª–¥–∞—É–Ω–∞ */
  display: flex;
  flex-direction: column;
  justify-content: center;
  width: 100%; /* –∑–∞–Ω–∏–º–∞—Ç—å –≤—Å—é —à–∏—Ä–∏–Ω—É */
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ */
button .btn-text {
  flex-grow: 1;
  line-height: 1.3;
  user-select: none;
  padding-top: 8px; /* –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –ø–æ–¥ –ø–æ–ª–æ—Å–∫–æ–π –∫—É–ª–¥–∞—É–Ω–∞ */
  width: 100%;
  white-space: normal;
}

/* Hover –∏ —Ñ–æ–∫—É—Å */
button:hover:not(:disabled), button:focus-visible:not(:disabled) {
  box-shadow: 0 0 15px rgba(0,255,0,0.5);
  background: linear-gradient(to bottom, #444, #222);
}

/* –û—Ç–∫–ª—é—á—ë–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
button:disabled {
  background: #2a2a2a;
  color: #666;
  border-color: #333;
  box-shadow: none;
}

/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∫—É–ª–¥–∞—É–Ω–∞ ‚Äî —Ç–µ–ø–µ—Ä—å —Å–≤–µ—Ä—Ö—É –∫–Ω–æ–ø–∫–∏ */
button .cooldown-bar {
  position: absolute;
  top: 0; /* —Å–≤–µ—Ä—Ö—É */
  left: 0;
  height: 6px;
  width: 100%;
  background: #444;
  border-radius: 10px 10px 0 0;
  overflow: hidden;
  z-index: 2;
}

/* –ó–∞–ø–æ–ª–Ω—è—é—â–∞—è –ø–æ–ª–æ—Å–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
button .cooldown-bar .progress {
  height: 100%;
  width: 0%;
  background: limegreen;
  transition: width 0.1s linear;
  border-radius: 10px 10px 0 0;
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ */
button.glow {
  box-shadow: 0 0 10px #0f0;
}

/* –û–≤–µ—Ä–ª–µ–π */
#overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-direction: column;
  display: none;
  z-index: 10;
  text-align: center;
  padding: 20px;
}

#overlay button {
  margin-top: 15px;
  font-size: 16px;
  padding: 8px 15px;
  display: none;
}



</style>


</head>
<body>
<div id="game">
  <div class="header">
    <span>üí∞ –ó–æ–ª–æ—Ç–æ: <span id="gold">100</span></span>
    <span>üïí –í—Ä–µ–º—è: <span id="timer">60</span></span>
    <span>üåä –í–æ–ª–Ω–∞: <span id="wave">1</span></span>
    <span>‚ù§Ô∏è: <span id="lives">5</span></span>
  </div>
  <div class="game-area">
    <canvas id="canvas" width="360" height="360"></canvas>
    <div id="overlay">
      <div id="message"></div>
      <button id="restartBtn">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>
  </div>
  <div class="button-panel">
    <div class="column" id="units"></div>
    <div class="column" id="upgrades"></div>
    <div class="column">
      <button id="waveBtn">‚ñ∂ –°—Ç–∞—Ä—Ç –í–æ–ª–Ω—ã
–ó–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—É—é –≤–æ–ª–Ω—É
–í—Ä–µ–º—è: 60 —Å–µ–∫</button>
    </div>
  </div>
</div>
<script>

(() => {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

// –û—Ç–∫–ª—é—á–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–∞—Å–∞–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–∫—Ä—É—Ç–∫–∞, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)
  canvas.style.touchAction = 'none';

  const goldEl = document.getElementById('gold');
  const timerEl = document.getElementById('timer');
  const waveEl = document.getElementById('wave');
  const livesEl = document.getElementById('lives');
  const overlay = document.getElementById('overlay');
  const message = document.getElementById('message');
  const restartBtn = document.getElementById('restartBtn');
  const unitsPanel = document.getElementById('units');
  const upgradesPanel = document.getElementById('upgrades');
  const waveBtn = document.getElementById('waveBtn');

  const W = canvas.width;
  const H = canvas.height;

  let gold = 100;
  let lives = 5;
  let wave = 1;
  let waveTimer = 60;
  let waveActive = false;
  let upgradeLevel = 0;
  let goldPerSec = 0;
  let lastGoldTick = 0;
  let entities = [];
  let lastTime = 0;
  let buyCooldowns = [0, 0, 0]; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —é–Ω–∏—Ç–∞


  const unitTypes = [
    { name: '–ú–µ—á–Ω–∏–∫', cost: 5, hp: 10, damage: 1, cooldown: 0.5, buyCooldown: 2000, color: 'blue', emoji: '‚öîÔ∏è' },
    { name: '–õ—É—á–Ω–∏–∫', cost: 15, hp: 5, damage: 2, cooldown: 1, buyCooldown: 4000, color: 'white', emoji: 'üèπ' },
    { name: '–ö—É–∑–Ω–µ—Ü', cost: 30, hp: 20, damage: 6, cooldown: 2, buyCooldown: 10000, color: 'green', emoji: 'üî®' }
  ];

  const upgrades = [
    {
      cost: 100,
      effect: () => { goldPerSec += 1; },
      description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–∞ –≤ —Å–µ–∫—É–Ω–¥—É +1',
    },
    {
      cost: 250,
      effect: () => {
        goldPerSec += 1;
        unitTypes.forEach(u => u.buyCooldown = Math.max(500, u.buyCooldown - 200));
      },
      description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–∞ –≤ —Å–µ–∫—É–Ω–¥—É +1 –∏ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–∞ –ø–æ–∫—É–ø–∫–∏',
    },
    {
      cost: 400,
      effect: () => {
        goldPerSec += 1;
        unitTypes.forEach(u => u.damage += 1);
      },
      description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–∞ –≤ —Å–µ–∫—É–Ω–¥—É +1 –∏ –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–Ω–∞ —é–Ω–∏—Ç–æ–≤',
    },
    {
      cost: 600,
      effect: () => {
        goldPerSec += 1;
        unitTypes.forEach(u => u.buyCooldown = Math.max(500, u.buyCooldown - 200));
      },
      description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–∞ –≤ —Å–µ–∫—É–Ω–¥—É +1 –∏ –¥–∞–ª—å–Ω–µ–π—à–µ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–∞ –ø–æ–∫—É–ø–∫–∏',
    },
    {
      cost: 800,
      effect: () => {
        goldPerSec += 1;
        unitTypes.forEach(u => {
          u.damage += 2;
          u.buyCooldown = Math.max(500, u.buyCooldown - 200);
        });
      },
      description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–∞ –≤ —Å–µ–∫—É–Ω–¥—É +1, –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–Ω–∞ –∏ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–∞',
    }
  ];


function generateUnitButtons() {
  unitsPanel.innerHTML = '';
  const now = Date.now();

  unitTypes.forEach((unit, i) => {
    const btn = document.createElement('button');

    const onCooldown = unit.buyCooldown ? (now - (buyCooldowns[i] || 0) < unit.buyCooldown) : false;
    btn.disabled = gold < unit.cost || onCooldown;

    btn.innerHTML = `
      <div class="btn-text">
        <div class="unit-name">${unit.emoji} ${unit.name}</div>
        <div class="unit-stats">
          <span>üí∞${unit.cost}</span> | 
          <span>‚ù§Ô∏è${unit.hp}</span> | 
          <span>‚öîÔ∏è${unit.damage}</span>
        </div>
        <div class="desc">–ö—É–ª–¥–∞—É–Ω –ø–æ–∫—É–ø–∫–∏: ${(unit.buyCooldown / 1000).toFixed(1)} —Å–µ–∫.</div>
      </div>
      <div class="cooldown-bar"><div class="progress"></div></div>
    `;

    if (onCooldown) {
      btn.classList.add('cooldown');
    } else {
      btn.classList.remove('cooldown');
    }

    btn.addEventListener('click', () => buyUnit(i));

    unitsPanel.appendChild(btn);
  });
}



function generateUpgradeButtons() {
  upgradesPanel.innerHTML = '';

  upgrades.forEach((upg, i) => {
    const btn = document.createElement('button');

    btn.disabled = i !== upgradeLevel || gold < upg.cost;

    btn.innerHTML = `
      <div class="upgrade-title">‚¨ÜÔ∏è –£–ª—É—á—à–µ–Ω–∏–µ ${i + 1}</div>
      <div class="upgrade-cost">üí∞${upg.cost}</div>
      <div class="upgrade-desc">${upg.description}</div>
    `;

    btn.addEventListener('click', () => {
      if (btn.disabled) return;
      if (gold >= upg.cost && i === upgradeLevel) {
        gold -= upg.cost;
        goldEl.textContent = gold;
        upg.effect();
        upgradeLevel++;
        generateUpgradeButtons();
        generateUnitButtons();
      }
    });

    upgradesPanel.appendChild(btn);
  });
}


function buyUnit(i) {
  const now = Date.now();
  const unit = unitTypes[i];
  if (!unit) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —é–Ω–∏—Ç–∞
  if (gold < unit.cost) return; // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞
  if (now - buyCooldowns[i] < unit.buyCooldown) return; // –ö—É–ª–¥–∞—É–Ω –Ω–∞ –ø–æ–∫—É–ø–∫—É

  gold -= unit.cost;
  goldEl.textContent = gold;

  buyCooldowns[i] = now;
  spawnUnit(unit);

  console.log(`Unit purchased: ${unit.name}`);

  generateUnitButtons(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–æ–ª–æ—Ç–∞
}



 function spawnUnit(u) {
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–∑–∏—Ü–∏—é, –æ—Ç—Å—Ç—É–ø–∞—è –ø–æ 20px –æ—Ç –∫—Ä–∞–µ–≤ –∫–∞–Ω–≤–∞—Å–∞
  const x = 20 + Math.random() * (W - 40);
  const y = 20 + Math.random() * (H - 40);

  entities.push({
    type: 'unit',
    name: u.name,
    hp: u.hp,
    maxHp: u.hp,
    damage: u.damage,
    cooldown: u.cooldown,
    x: x,
    y: y,
    lastAttack: 0,
    blink: false,
    color: u.color,
    emoji: u.emoji,
    radius: 12
  });
}


  function spawnEnemy(type) {
  const enemyStats = {
    red:   { hp: 6, damage: 2, color: 'red',    emoji: 'üò°' },
    yellow:{ hp: 9, damage: 1, color: 'yellow', emoji: 'üòê' }
  };

  const stats = enemyStats[type] || enemyStats.yellow;

  const x = 20 + Math.random() * (W - 40);
  const y = 20 + Math.random() * (H - 40);

  entities.push({
    type: 'enemy',
    hp: stats.hp,
    maxHp: stats.hp,
    damage: stats.damage,
    cooldown: 1,
    x, y,
    lastAttack: 0,
    blink: false,
    color: stats.color,
    emoji: stats.emoji,
    radius: 12
  });
}


  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–∞–≥–æ–≤ —Å –º–∏–Ω–∏–º—É–º–æ–º 3 —à—Ç.
function generateEnemies() {
  let hpSum = 0;
  const power = Math.floor(gold / 2);
  let tries = 0;
  let enemiesCount = 0;
  
  while ((hpSum < power || enemiesCount < 3) && tries < 50) {
    const t = Math.random() < 0.5 ? 'red' : 'yellow';
    const hp = t === 'red' ? 6 : 9;
    if (hpSum + hp <= power || enemiesCount < 3) {
      spawnEnemy(t);
      hpSum += hp;
      enemiesCount++;
    }
    tries++;
  }
}


  // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Å—É—â–Ω–æ—Å—Ç—è–º–∏
function distance(a, b) {
  return Math.hypot(a.x - b.x, a.y - b.y);
}

// –ù–∞—Ö–æ–¥–∏—Ç –±–ª–∏–∂–∞–π—à–µ–≥–æ —é–Ω–∏—Ç–∞ –∏–ª–∏ –≤—Ä–∞–≥–∞ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç type)
function findNearest(from, type) {
  let minDist = Infinity;
  let target = null;
  for (const e of entities) {
    if (e.type !== type || e.hp <= 0) continue;
    const d = distance(from, e);
    if (d < minDist) {
      minDist = d;
      target = e;
    }
  }
  return target;
}

// –î–≤–∏–≥–∞–µ—Ç —Å—É—â–Ω–æ—Å—Ç—å a –∫ b —Å —É—á–µ—Ç–æ–º —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ deltaTime
function moveTowards(a, b, speed, dt) {
  const dx = b.x - a.x;
  const dy = b.y - a.y;
  const dist = Math.hypot(dx, dy);
  if (dist > 0) {
    const step = speed * dt;
    if (step >= dist) {
      a.x = b.x;
      a.y = b.y;
    } else {
      a.x += (dx / dist) * step;
      a.y += (dy / dist) * step;
    }
  }
}


 // –ê—Ç–∞–∫–∞ —Å —É—á–µ—Ç–æ–º –∫—É–ª–¥–∞—É–Ω–∞ –∏ –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ HP
function attack(a, b, now) {
  if (now - a.lastAttack >= a.cooldown) {
    b.hp = Math.max(0, b.hp - a.damage); // HP –Ω–µ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –Ω–∏–∂–µ 0
    a.lastAttack = now;
    a.blink = true;
    setTimeout(() => { a.blink = false; }, 100); // —É–≤–µ–ª–∏—á–∏–ª –º–∏–≥–∞–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π
function resolveCollisions() {
  for (let i = 0; i < entities.length; i++) {
    for (let j = i + 1; j < entities.length; j++) {
      const a = entities[i];
      const b = entities[j];
      if (a.hp <= 0 || b.hp <= 0) continue;

      const dx = a.x - b.x;
      const dy = a.y - b.y;
      const dist = Math.hypot(dx, dy);
      const minDist = a.radius + b.radius;

      if (dist > 0 && dist < minDist) {
        const overlap = (minDist - dist) / 2;
        const nx = dx / dist;
        const ny = dy / dist;
        const pushStrength = 0.8; // –ø–ª–∞–≤–Ω–æ—Å—Ç—å —Å–¥–≤–∏–≥–∞

        a.x += nx * overlap * pushStrength;
        a.y += ny * overlap * pushStrength;
        b.x -= nx * overlap * pushStrength;
        b.y -= ny * overlap * pushStrength;

        // –ú–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º, –Ω–∞–ø—Ä–∏–º–µ—Ä:
        a.x = Math.min(Math.max(a.x, a.radius), W - a.radius);
        a.y = Math.min(Math.max(a.y, a.radius), H - a.radius);
        b.x = Math.min(Math.max(b.x, b.radius), W - b.radius);
        b.y = Math.min(Math.max(b.y, b.radius), H - b.radius);

      } else if (dist === 0) {
        const randAngle = Math.random() * 2 * Math.PI;
        const smallShift = 2; // —á—É—Ç—å –±–æ–ª—å—à–µ —Å–¥–≤–∏–≥
        a.x += Math.cos(randAngle) * smallShift;
        a.y += Math.sin(randAngle) * smallShift;
        b.x -= Math.cos(randAngle) * smallShift;
        b.y -= Math.sin(randAngle) * smallShift;
      }
    }
  }
}


  function updateEntities(dt, now) {
  for (const e of entities) {
    if (e.hp <= 0) continue;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ü–µ–ª–∏: —é–Ω–∏—Ç –∞—Ç–∞–∫—É–µ—Ç –≤—Ä–∞–≥–æ–≤, –≤—Ä–∞–≥ –∞—Ç–∞–∫—É–µ—Ç —é–Ω–∏—Ç–æ–≤
    const targetType = e.type === 'unit' ? 'enemy' : 'unit';
    const target = findNearest(e, targetType);
    if (!target) continue;

    const dist = distance(e, target);
    const attackRange = e.radius + target.radius + 2;

    if (dist > attackRange) {
      // –ï—Å–ª–∏ —Ü–µ–ª—å –¥–∞–ª–µ–∫–æ ‚Äî –¥–≤–∏–≥–∞–µ–º—Å—è –∫ –Ω–µ–π
      moveTowards(e, target, 80, dt);
    } else {
      // –ï—Å–ª–∏ –≤ —Ä–∞–¥–∏—É—Å–µ –∞—Ç–∞–∫–∏ ‚Äî –∞—Ç–∞–∫—É–µ–º
      attack(e, target, now);
    }
  }

  // –ü–æ—Å–ª–µ –¥–≤–∏–∂–µ–Ω–∏—è –∏ –∞—Ç–∞–∫ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω–∞–ª–æ–∂–µ–Ω–∏–π
  resolveCollisions();

  // –£–¥–∞–ª—è–µ–º –º–µ—Ä—Ç–≤—ã—Ö
  entities = entities.filter(e => e.hp > 0);
}



function drawEntities() {
  ctx.clearRect(0, 0, W, H);

  for (const e of entities) {
    // –ú–∏–≥–∞—Ç—å –ø—Ä–∏ –∞—Ç–∞–∫–µ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –≤ —ç—Ç–æ—Ç –∫–∞–¥—Ä
    if (e.blink) continue;

    // –†–∏—Å—É–µ–º —Ç–µ–ª–æ –∫—Ä—É–≥–∞
    ctx.beginPath();
    ctx.fillStyle = e.color;
    ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
    ctx.fill();

    // –†–∏—Å—É–µ–º —ç–º–æ–¥–∂–∏ –ø–æ–≤–µ—Ä—Ö –∫—Ä—É–≥–∞
    ctx.fillStyle = '#fff';
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(e.emoji, e.x, e.y);

    // –†–∏—Å—É–µ–º HP-–±–∞—Ä
    const barWidth = 24;
    const barHeight = 4;
    const hpPercent = Math.max(e.hp / e.maxHp, 0);
    ctx.fillStyle = 'red';
    ctx.fillRect(e.x - barWidth / 2, e.y + e.radius + 6, barWidth, barHeight);
    ctx.fillStyle = 'limegreen';
    ctx.fillRect(e.x - barWidth / 2, e.y + e.radius + 6, barWidth * hpPercent, barHeight);

    // –¶–∏—Ñ—Ä–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ HP –ø–æ–¥ –±–∞—Ä–æ–º
    ctx.fillStyle = '#fff';
    ctx.font = '10px monospace';
    ctx.fillText(Math.max(0, Math.floor(e.hp)), e.x, e.y + e.radius + 18);
  }
}



restartBtn.onclick = () => {
  hideMessage();
  restartGame();
};



 function showMessage(msg, showRestart = false, callback = null) {
  overlay.style.opacity = '0';
  overlay.style.display = 'flex';
  
  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫ ‚Äî –∑–∞–º–µ–Ω—è–µ–º \n –Ω–∞ <br>
  message.innerHTML = msg.replace(/\n/g, '<br>');
  
  restartBtn.style.display = showRestart ? 'inline-block' : 'none';

  // –ü–ª–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
  requestAnimationFrame(() => {
    overlay.style.transition = 'opacity 0.3s ease';
    overlay.style.opacity = '1';
  });

  if (typeof callback === 'function') {
    // –í—ã–∑–æ–≤ callback –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ (300ms)
    setTimeout(() => {
      callback();
    }, 300);
  }
}


function hideMessage(callback = null) {
  overlay.style.transition = 'opacity 0.3s ease';
  overlay.style.opacity = '0';
  setTimeout(() => {
    overlay.style.display = 'none';
    if (typeof callback === 'function') callback();
  }, 300);
}

function restartGame() {
  gold = 100;
  lives = 5;
  wave = 1;
  waveTimer = 60;
  waveActive = false;
  upgradeLevel = 0;
  goldPerSec = 0;
  lastGoldTick = 0;
  entities = [];
  buyCooldowns.fill(0);

  // buyCooldowns = [0, 0, 0]; // –°–±—Ä–æ—Å –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é


  generateUnitButtons();
  generateUpgradeButtons();
  updateUI();
  hideMessage();
  waveBtn.disabled = false;
  waveBtn.textContent = "‚ñ∂ –°—Ç–∞—Ä—Ç –í–æ–ª–Ω—ã";
}


// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –≤–∫–ª—é—á–∞—è –∫–Ω–æ–ø–∫–∏ –∏ –¥—Ä—É–≥–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
updateUI();

hideMessage();

waveBtn.disabled = false;
waveBtn.textContent = "‚ñ∂ –°—Ç–∞—Ä—Ç –í–æ–ª–Ω—ã";


function updateUI() {
  goldEl.textContent = gold;
  livesEl.textContent = lives;
  waveEl.textContent = wave;
  timerEl.textContent = waveActive ? Math.ceil(waveTimer) : 0;

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —é–Ω–∏—Ç–æ–≤ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –∫—É–ª–¥–∞—É–Ω–∞
  if (unitsPanel.children.length === unitTypes.length) {
    const now = Date.now();
    Array.from(unitsPanel.children).forEach((btn, i) => {
      const onCooldown = (now - buyCooldowns[i]) < unitTypes[i].buyCooldown;
      btn.disabled = gold < unitTypes[i].cost || onCooldown;

      if (onCooldown) {
        btn.classList.add('cooldown');

        const elapsed = now - buyCooldowns[i];
        const cooldown = unitTypes[i].buyCooldown;
        const progressPercent = Math.min(100, (elapsed / cooldown) * 100);

        const progressBar = btn.querySelector('.cooldown-bar .progress');
        if (progressBar) {
          progressBar.style.width = progressPercent + '%';
        }
      } else {
        btn.classList.remove('cooldown');

        const progressBar = btn.querySelector('.cooldown-bar .progress');
        if (progressBar) {
          progressBar.style.width = '100%'; // –∏–ª–∏ '0%', –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—É—Å—Ç–æ–π –±–∞—Ä
        }
      }
    });
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —É–ª—É—á—à–µ–Ω–∏–π
  if (upgradesPanel.children.length === upgrades.length) {
    Array.from(upgradesPanel.children).forEach((btn, i) => {
      btn.disabled = (i !== upgradeLevel) || (gold < upgrades[i].cost);
    });
  }
}



// –ù–∞—á–∞—Ç—å –≤–æ–ª–Ω—É
function startWave() {
  if (waveActive) return;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —é–Ω–∏—Ç
  if (entities.filter(e => e.type === 'unit').length === 0) {
    alert('–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —é–Ω–∏—Ç–∞ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º –≤–æ–ª–Ω—ã!');
    return;
  }

  waveActive = true;
  waveTimer = 60;

  // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —é–Ω–∏—Ç–æ–≤ (—É–¥–∞–ª—è–µ–º –≤—Ä–∞–≥–æ–≤ —Å –ø—Ä–æ—à–ª–æ–π –≤–æ–ª–Ω—ã)
  entities = entities.filter(e => e.type === 'unit');

  generateEnemies();

  waveBtn.textContent = '‚ñ† –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ–ª–Ω—É';

  updateUI();
}

// –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ–ª–Ω—É —Å –ø–æ—Ç–µ—Ä–µ–π –∂–∏–∑–Ω–∏
function stopWave() {
  waveActive = false;
  waveBtn.textContent = '‚ñ∂ –°—Ç–∞—Ä—Ç –í–æ–ª–Ω—ã';

  lives--;
  updateUI();

  if (lives <= 0) {
    showMessage('üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!\n–ñ–∏–∑–Ω–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å', true);
    waveBtn.disabled = true;
  } else {
    showMessage(`‚è∞ –í–æ–ª–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!\n‚àí1 –∂–∏–∑–Ω—å\n–û—Å—Ç–∞–ª–æ—Å—å –∂–∏–∑–Ω–µ–π: ${lives}`, false);
  }
}

waveBtn.onclick = () => {
  if (!waveActive) {
    console.log('clicked start wave');
    hideMessage();
    startWave();
  } else {
    console.log('clicked stop wave');
    stopWave();
  }
};

// –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
function gameLoop(time = 0) {
  if (!lastTime) lastTime = time;
  const dt = (time - lastTime) / 1000;
  lastTime = time;

  if (waveActive) {
    waveTimer -= dt;
    if (waveTimer < 0) waveTimer = 0;

    while (time - lastGoldTick >= 1000) {
      gold += goldPerSec;
      lastGoldTick += 1000;
    }
    goldEl.textContent = gold;

    updateEntities(dt, time / 1000);

    const enemiesLeft = entities.filter(e => e.type === 'enemy').length;

    if (enemiesLeft === 0) {
      const bonusGold = Math.floor(goldPerSec * waveTimer);
      const reward = wave * 10;
      gold += 100 + bonusGold + reward;
      waveActive = false;
      waveBtn.textContent = '‚ñ∂ –°—Ç–∞—Ä—Ç –í–æ–ª–Ω—ã';
      updateUI();
      showMessage(`üéâ –ü–æ–±–µ–¥–∞!\n–ù–∞–≥—Ä–∞–¥–∞: 100 + ${bonusGold} (–∑–∞ –≤—Ä–µ–º—è) + ${reward}\n–í—Å–µ–≥–æ –∑–æ–ª–æ—Ç–∞: ${gold}`, false);
      wave++;
    } else if (waveTimer === 0 && enemiesLeft > 0) {
      lives--;
      waveActive = false;
      waveBtn.textContent = '‚ñ∂ –°—Ç–∞—Ä—Ç –í–æ–ª–Ω—ã';
      updateUI();
      if (lives <= 0) {
        showMessage(`üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!\n–ñ–∏–∑–Ω–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å`, true);
        waveBtn.disabled = true;
      } else {
        showMessage(`‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ!\n‚àí1 –∂–∏–∑–Ω—å\n–û—Å—Ç–∞–ª–æ—Å—å: ${lives}`, false);
      }
    }

    updateUI();
  } else {
    updateUI();
  }

  drawEntities();
  requestAnimationFrame(gameLoop);
}



  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  restartGame();
  requestAnimationFrame(gameLoop);

  // –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ - –∑–∞–ø—Ä–µ—Ç —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏ –∫–∞–Ω–≤–∞—Å–∞
  canvas.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
})();

</script>
</body>
</html>
